name: Appium Tests (Reusable)

on:
  workflow_call:
    inputs:
      source:
        description: "Trigger source"
        required: false
        type: string
      tags:
        description: "Test tags to run (e.g. regression, login)"
        required: false
        type: string
        default: ""
      platform:
        description: "Test platform (android/ios)"
        required: true
        type: string
        default: "android"
      environment:
        description: "Test environment (staging/sit/production)"
        required: false
        type: string
        default: "sit"
    secrets:
      RUNNER_TOKEN:
        required: true
      BROWSERSTACK_USERNAME:
        required: true
      BROWSERSTACK_ACCESS_KEY:
        required: true
      BROWSERSTACK_ANDROID_APP_ID_STAGING:
        required: true
      BROWSERSTACK_ANDROID_APP_ID_SIT:
        required: true
      BROWSERSTACK_ANDROID_APP_ID_PRODUCTION:
        required: true
      BROWSERSTACK_IOS_APP_ID_STAGING:
        required: true
      BROWSERSTACK_IOS_APP_ID_SIT:
        required: true
      BROWSERSTACK_IOS_APP_ID_PRODUCTION:
        required: true
      AWS_DEV_GITHUB_ACTION_ROLE:
        required: true

permissions:
  id-token: write
  contents: read
  actions: read

env:
  PYTHON_VERSION: "3.9"
  AWS_REGION: ap-northeast-1
  S3_BUCKET: hotcake-devops-site
  S3_REPORT_PATH: e2e-tests-allure-report

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: hungerapp/react-native-appium
          ref: main
          token: ${{ secrets.RUNNER_TOKEN }}

      - name: Configure AWS Credentials
        id: aws-creds
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEV_GITHUB_ACTION_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          echo "Current working directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          echo "Looking for requirements.txt:"
          find . -name "requirements.txt" -type f 2>/dev/null || echo "requirements.txt not found"
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, installing basic dependencies"
            pip install pytest Appium-Python-Client selenium allure-pytest python-dotenv requests
          fi
          
          # Install AWS CLI only if AWS credentials step succeeded
          if [ "${{ steps.aws-creds.outcome }}" = "success" ]; then
            echo "Installing AWS CLI for report uploading..."
            pip install awscli
          else
            echo "AWS credentials not available, skipping AWS CLI installation"
          fi

      - name: Install Allure CLI
        continue-on-error: true
        run: npm install -g allure-commandline --save-dev

      - name: Create Test Directories
        run: |
          mkdir -p allure-results
          mkdir -p allure-report


      - name: Set Taipei Timestamp
        run: |
          echo "TAIPEI_DATE=$(TZ='Asia/Taipei' date +'%Y%m%d')" >> $GITHUB_ENV
          echo "TAIPEI_TIME=$(TZ='Asia/Taipei' date +'%H%M')" >> $GITHUB_ENV

      - name: Run tests
        env:
          # GitHub Actions environment identifier
          TEST_ENV: github_actions
          
          # Test runner settings
          TEST_RUNNER: browserstack
          
          # Application environment settings
          APPIUM_OS: ${{ inputs.platform || 'android' }}
          APPIUM_ENV: ${{ inputs.environment || 'sit' }}
          API_ENVIRONMENT: ${{ inputs.environment == 'sit' && 'sit' || inputs.environment || 'sit' }}
          
          # Basic test configuration
          IMPLICIT_WAIT: 25
          NO_RESET: False
          AUTO_ACCEPT_ALERTS: True
          DEVICE_COUNT: 1
          
          # BrowserStack credentials
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_HUB_URL: https://hub-cloud.browserstack.com/wd/hub
          
          # BrowserStack project settings
          BROWSERSTACK_PROJECT_NAME: "Hotcake App - E2E Tests"
          BROWSERSTACK_BUILD_NAME: "${{ env.TAIPEI_DATE }}-GA-${{ inputs.platform }}-${{ inputs.environment || 'sit' }}"
          BROWSERSTACK_SESSION_NAME: "Call-${{ env.TAIPEI_TIME }}-${{ inputs.test_file != '' && inputs.test_file || inputs.tags != '' && inputs.tags || 'All-Tests' }}"
          
          # BrowserStack device settings
          BROWSERSTACK_DEVICE_NAME: ${{ inputs.platform == 'android' && 'Google Pixel 8' || inputs.platform == 'pados' && 'iPad Pro 11 2024' || 'iPhone 15 Pro' }}
          BROWSERSTACK_OS_VERSION: ${{ inputs.platform == 'android' && '14.0' || inputs.platform == 'pados' && '17.0' || '17.0' }}
          
          # BrowserStack application ID (dynamic based on environment and platform)
          BROWSERSTACK_ANDROID_APP_ID_STAGING: ${{ secrets.BROWSERSTACK_ANDROID_APP_ID_STAGING }}
          BROWSERSTACK_ANDROID_APP_ID_SIT: ${{ secrets.BROWSERSTACK_ANDROID_APP_ID_SIT }}
          BROWSERSTACK_ANDROID_APP_ID_PRODUCTION: ${{ secrets.BROWSERSTACK_ANDROID_APP_ID_PRODUCTION }}
          BROWSERSTACK_IOS_APP_ID_STAGING: ${{ secrets.BROWSERSTACK_IOS_APP_ID_STAGING }}
          BROWSERSTACK_IOS_APP_ID_SIT: ${{ secrets.BROWSERSTACK_IOS_APP_ID_SIT }}
          BROWSERSTACK_IOS_APP_ID_PRODUCTION: ${{ secrets.BROWSERSTACK_IOS_APP_ID_PRODUCTION }}
          
          # Application ID settings
          APP_ID_STAGING: "com.hunger.hotcakeapp.staging"
          APP_ID_SIT: "com.hunger.hotcakeapp.sit"
          APP_ID_PRODUCTION: "com.hunger.hotcakeapp"
          
          # Branch selection settings
          BRANCH_NAME_STAGING: "Pro ÂàÜÂ∫ó"
          BRANCH_NAME_SIT: "Ëá∫Âåó ‰∏≠Ê≠£ Â∫ó"
          BRANCH_NAME_PRODUCTION: "Pro ÂàÜÂ∫ó"


        run: |
          echo "Running ${{ inputs.platform || 'android' }} E2E tests..."

          # Install and start BrowserStack local test tool
          curl -L https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip -o BrowserStackLocal.zip
          unzip BrowserStackLocal.zip
          ./BrowserStackLocal --key ${{ secrets.BROWSERSTACK_ACCESS_KEY }} --daemon start

          # Set test parameters (environment variables are set in .env)
          
          # Run tests
          if [ -n "${{ inputs.tags }}" ]; then
            echo "Running tests with tag: ${{ inputs.tags }}"
            python -m pytest -v -k "${{ inputs.tags }}" --platform ${{ inputs.platform || 'android' }} --runner browserstack --env ${{ inputs.environment || 'sit' }} --alluredir=allure-results
          else
            echo "Running tests with platform: ${{ inputs.platform || 'android' }}"
            python -m pytest -v --platform ${{ inputs.platform || 'android' }} --runner browserstack --env ${{ inputs.environment || 'sit' }} --alluredir=allure-results
          fi

      - name: Generate Allure Report
        if: always()
        continue-on-error: true
        run: allure generate --clean -o allure-report allure-results

      - name: Sync Allure Report to S3 (history)
        if: always() && steps.aws-creds.outcome == 'success'
        continue-on-error: true
        run: |
          TIMESTAMP=$(TZ='Asia/Taipei' date +'%Y%m%d-%H%M')
          aws s3 sync allure-report s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/$TIMESTAMP --delete
          echo "trigger" > build_type.txt
          aws s3 cp build_type.txt s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/$TIMESTAMP/build_type.txt
          echo "History report sync completed"

      - name: Sync Allure Report to S3 (latest)
        if: always() && steps.aws-creds.outcome == 'success'
        continue-on-error: true
        run: |
          # Upload to temporary directory
          aws s3 sync allure-report s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/temp-latest --delete

          # Delete old latest
          aws s3 rm s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/latest/ --recursive

          # Rename temporary directory to latest
          aws s3 sync s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/temp-latest s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/latest

          # Add build_type.txt
          echo "trigger" > build_type.txt
          aws s3 cp build_type.txt s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/latest/build_type.txt

          # Clean temporary directory
          aws s3 rm s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/temp-latest/ --recursive
          
          # Verify sync status
          echo "üîç È©óË≠â latest ÁõÆÈåÑÂêåÊ≠•ÁãÄÊ≥Å..."
          if aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/latest/index.html; then
            echo "‚úÖ Latest report sync completed successfully"
            echo "üìã Latest ÁõÆÈåÑÂÖßÂÆπÔºö"
            aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/latest/ --recursive
          else
            echo "‚ùå Latest report sync failed"
            echo "üìã Ê™¢Êü• temp-latest ÊòØÂê¶Â≠òÂú®Ôºö"
            aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/temp-latest/ --recursive || echo "temp-latest ÁõÆÈåÑ‰∏çÂ≠òÂú®"
            exit 1
          fi

      - name: Generate Allure Index Page
        if: always() && steps.aws-creds.outcome == 'success'
        continue-on-error: true
        run: |
          sleep 10
          # Create index page directory
          mkdir -p allure-index
          INDEX_FILE=allure-index/index.html

          # Get existing report list from S3
          echo "Fetching existing reports from S3..."
          EXISTING_REPORTS=$(aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/ | grep 'PRE' | awk '{print $2}' | sed 's/\///g' | grep -E '^[0-9]{8}-[0-9]{4}$' | sort -r) || true

          # Generate HTML index page
          cat > $INDEX_FILE << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <title>Allure Reports Index - E2E Test Reports</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .header {
                      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
                      color: white;
                      padding: 30px;
                      border-radius: 10px;
                      margin-bottom: 30px;
                      text-align: center;
                  }
                  .header h1 {
                      margin: 0;
                      font-size: 2.5em;
                  }
                  .header p {
                      margin: 10px 0 0 0;
                      opacity: 0.9;
                  }
                  .reports-container {
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  .report-card {
                      background: white;
                      border-radius: 10px;
                      padding: 20px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  .report-card:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                  }
                  .report-card.latest {
                      border: 2px solid #28a745;
                      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                      color: white;
                  }
                  .report-card.latest .report-title {
                      color: white;
                  }
                  .report-title {
                      font-size: 1.2em;
                      font-weight: bold;
                      margin-bottom: 10px;
                      color: #333;
                  }
                  .report-type {
                      color: #666;
                      font-size: 0.95em;
                      margin-bottom: 15px;
                      font-weight: 500;
                  }
                  .report-card.latest .report-type {
                      color: rgba(255,255,255,0.9);
                  }
                  .report-link {
                      display: inline-block;
                      background: #007bff;
                      color: white;
                      text-decoration: none;
                      padding: 10px 20px;
                      border-radius: 5px;
                      transition: background 0.2s;
                  }
                  .report-link:hover {
                      background: #0056b3;
                      text-decoration: none;
                      color: white;
                  }
                  .report-card.latest .report-link {
                      background: rgba(255,255,255,0.2);
                      color: white;
                  }
                  .report-card.latest .report-link:hover {
                      background: rgba(255,255,255,0.3);
                  }
                  .no-reports {
                      text-align: center;
                      color: #666;
                      font-style: italic;
                      grid-column: 1 / -1;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>üß™ E2E Test Reports</h1>
              </div>
              
              <div class="reports-container">
          EOF

          # Add latest report card - pointing to the latest timestamp report
          if [ -n "$EXISTING_REPORTS" ]; then
            LATEST_REPORT=$(echo "$EXISTING_REPORTS" | head -1)
            cat >> $INDEX_FILE << EOF
                  <div class="report-card latest">
                      <div class="report-title">üöÄ Latest Report ($LATEST_REPORT)</div>
                      <div class="report-type">Most recent test execution</div>
                      <a href="./$LATEST_REPORT/index.html" class="report-link">View Latest Report</a>
                  </div>
          EOF
          else
            cat >> $INDEX_FILE << 'EOF'
                  <div class="report-card latest">
                      <div class="report-title">üöÄ Latest Report</div>
                      <div class="report-type">No recent test execution</div>
                      <span class="report-link" style="background: #ccc; cursor: not-allowed;">No Reports Available</span>
                  </div>
          EOF
          fi

          # Add historical reports
          if [ -n "$EXISTING_REPORTS" ]; then
            echo "$EXISTING_REPORTS" | while read -r report_dir; do
              if [ -n "$report_dir" ] && [ "$report_dir" != "latest" ]; then
                # Read build type
                BUILD_TYPE=$(aws s3 cp s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/$report_dir/build_type.txt - 2>/dev/null || echo "unknown")
                echo "Report $report_dir build type: $BUILD_TYPE"

                case $BUILD_TYPE in
                  "scheduled") ICON="ü§ñ"; TYPE_NAME="Scheduled Run" ;;
                  "manual") ICON="üë§"; TYPE_NAME="Manual Run" ;;
                  "trigger") ICON="üîÑ"; TYPE_NAME="Trigger Run" ;;
                  *) ICON="‚ùì"; TYPE_NAME="Unknown Run ($BUILD_TYPE)" ;;
                esac
                
                if [ "$BUILD_TYPE" = "unknown" ]; then
                  hour=${report_dir:9:2}
                  if [ "$hour" = "18" ] || [ "$hour" = "02" ]; then
                    BUILD_TYPE="scheduled"
                    ICON="ü§ñ"; TYPE_NAME="Scheduled Run"
                  else
                    BUILD_TYPE="trigger"
                    ICON="üîÑ"; TYPE_NAME="Trigger Run"
                  fi
                fi
                
                cat >> $INDEX_FILE << EOF
                  <div class="report-card">
                      <div class="report-title">üìä Report $report_dir</div>
                      <div class="report-type">$ICON $TYPE_NAME</div>
                      <a href="./$report_dir/index.html" class="report-link">View Report</a>
                  </div>
          EOF
              fi
            done
          else
            cat >> $INDEX_FILE << 'EOF'
                  <div class="no-reports">
                      No historical reports found
                  </div>
          EOF
          fi

          # Close HTML
          cat >> $INDEX_FILE << 'EOF'
              </div>
              
              <div style="text-align: center; margin-top: 30px; color: #666; font-size: 0.9em;">
                  ¬© 2025 Hotcake. All rights reserved.
              </div>
          </body>
          </html>
          EOF

          echo "Generated index page at $INDEX_FILE"

      - name: Upload Index Page to S3
        if: always() && steps.aws-creds.outcome == 'success'
        continue-on-error: true
        run: |
          aws s3 cp allure-index/index.html s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/index.html
          echo "Index page uploaded to S3"

      - name: Clean old reports (keep 14 days)
        if: always() && steps.aws-creds.outcome == 'success'
        continue-on-error: true
        run: |
          CUTOFF_DATE=$(TZ='Asia/Taipei' date -d '14 days ago' +'%Y%m%d')
          echo "Cleaning reports older than $CUTOFF_DATE (keeping 14 days)"

          aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/ | \
          grep 'PRE' | awk '{print $2}' | sed 's/\///g' | \
          grep -E '^[0-9]{8}-[0-9]{4}$' | \
          while read report_dir; do
            report_date=${report_dir:0:8}
            if [ "$report_date" -lt "$CUTOFF_DATE" ]; then
              echo "üóëÔ∏è Deleting old report: $report_dir (created: $report_date)"
              aws s3 rm s3://${{ env.S3_BUCKET }}/${{ env.S3_REPORT_PATH }}/$report_dir/ --recursive
            else
              echo "‚úÖ Keeping recent report: $report_dir (created: $report_date)"
            fi
          done

          echo "‚ú® Cleanup completed - reports older than $CUTOFF_DATE have been removed"

      - name: Debug allure-report content
        if: always()
        run: ls -l allure-report

      - name: Check Allure CLI version
        if: always()
        run: allure --version
